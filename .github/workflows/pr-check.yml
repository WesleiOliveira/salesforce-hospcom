name: PR Check - Valida√ß√£o de Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: Valida√ß√£o de Pull Request
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar depend√™ncias
        run: npm ci

      - name: Verificar formata√ß√£o (Prettier)
        run: npm run prettier:verify
        continue-on-error: false

      - name: Executar ESLint
        run: npm run lint
        continue-on-error: false

      - name: Verificar estrutura do commit
        run: |
          echo "Verificando mensagens de commit..."
          git log origin/${{ github.base_ref }}..HEAD --format="%s" | while read commit_msg; do
            if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?:"; then
              echo "‚ùå Commit n√£o segue conventional commits: $commit_msg"
              echo "Formato esperado: tipo(escopo): descri√ß√£o"
              echo "Tipos v√°lidos: feat, fix, docs, style, refactor, test, chore"
              exit 1
            fi
          done
        continue-on-error: false

      - name: Validar arquivos modificados
        run: |
          echo "üìã Arquivos modificados no PR:"
          git diff --name-only origin/${{ github.base_ref }}...HEAD | head -20
          
          echo ""
          echo "üîç Verificando arquivos cr√≠ticos..."
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -qE "(package\.json|sfdx-project\.json|\.forceignore)"; then
            echo "‚ö†Ô∏è  Arquivos de configura√ß√£o modificados - aten√ß√£o necess√°ria"
          fi

      - name: Resumo da valida√ß√£o
        if: always()
        run: |
          echo "‚úÖ Valida√ß√µes de PR conclu√≠das"
          echo "PR: ${{ github.event.pull_request.number }}"
          echo "Branch: ${{ github.head_ref }} ‚Üí ${{ github.base_ref }}"
