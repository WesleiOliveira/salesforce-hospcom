name: PR Validate Salesforce - Valida√ß√£o na Org de Homolog

on:
  issue_comment:
    types: [created]

jobs:
  validate-salesforce:
    name: Validar no Salesforce (Homolog)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    # S√≥ executa se for um coment√°rio em um PR e o coment√°rio for "validar"
    if: |
      github.event.issue.pull_request != null &&
      github.event.comment.body == 'validar'

    steps:
      - name: Verificar se PR est√° aberto
        id: check_pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            if (pr.state !== 'open') {
              core.setFailed('PR n√£o est√° aberto');
              return;
            }
            
            if (pr.base.ref !== 'integration') {
              core.setFailed('PR deve ser para a branch integration');
              return;
            }
            
            core.setOutput('pr_number', pr.number);
            core.setOutput('head_sha', pr.head.sha);

      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.check_pr.outputs.head_sha }}
          fetch-depth: 0

      - name: Configurar SFDX CLI
        uses: salesforce/setup-sfdx@v1

      - name: Autenticar na org de homolog
        env:
          SF_USERNAME: ${{ secrets.SF_USERNAME_HOMOLOG }}
          SF_PASSWORD: ${{ secrets.SF_PASSWORD_HOMOLOG }}
          SF_SECURITY_TOKEN: ${{ secrets.SF_SECURITY_TOKEN_HOMOLOG }}
          SF_LOGIN_URL: ${{ secrets.SF_LOGIN_URL_HOMOLOG }}
        run: |
          echo "y" | sf org login web --alias homolog-validation --instance-url $SF_LOGIN_URL --set-default

      - name: Instalar jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Executar valida√ß√£o no Salesforce
        id: validate
        continue-on-error: true
        run: |
          echo "üîç Executando valida√ß√£o na org de homolog..."
          
          # Executar valida√ß√£o e capturar output JSON
          set +e
          VALIDATION_OUTPUT=$(sf project deploy validate \
            --source-dir force-app \
            --target-org homolog-validation \
            --ignore-warnings \
            --wait 10 \
            --json 2>&1)
          VALIDATION_EXIT_CODE=$?
          set -e
          
          # Salvar output em arquivo para debug
          echo "$VALIDATION_OUTPUT" > validation-output.json
          
          # Tentar extrair JSON v√°lido do output
          JSON_OUTPUT=$(echo "$VALIDATION_OUTPUT" | grep -o '{.*}' | tail -1 || echo "")
          
          if [ -z "$JSON_OUTPUT" ]; then
            # Se n√£o encontrou JSON, pode ser erro de autentica√ß√£o ou outro problema
            echo "‚ùå Erro ao executar valida√ß√£o. Output:"
            echo "$VALIDATION_OUTPUT"
            echo "validation_success=false" >> $GITHUB_OUTPUT
            echo "validation_errors<<EOF" >> $GITHUB_OUTPUT
            echo "Erro ao executar valida√ß√£o. Verifique os logs do workflow." >> $GITHUB_OUTPUT
            echo "$VALIDATION_OUTPUT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Verificar status da valida√ß√£o
          STATUS=$(echo "$JSON_OUTPUT" | jq -r '.status // .result.status // 1' 2>/dev/null || echo "1")
          SUCCESS=$(echo "$JSON_OUTPUT" | jq -r '.result.success // false' 2>/dev/null || echo "false")
          
          # Verificar se h√° erros
          HAS_ERRORS=$(echo "$JSON_OUTPUT" | jq -r '.result.details.componentFailures // [] | length' 2>/dev/null || echo "0")
          
          if [ "$STATUS" = "0" ] && [ "$SUCCESS" = "true" ] && [ "$HAS_ERRORS" = "0" ]; then
            echo "‚úÖ Valida√ß√£o conclu√≠da com sucesso!"
            echo "validation_success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Valida√ß√£o falhou"
            echo "validation_success=false" >> $GITHUB_OUTPUT
            
            # Extrair mensagens de erro
            ERROR_MESSAGES=$(echo "$JSON_OUTPUT" | jq -r '.result.details.componentFailures[]? | "\(.fileName):\(.lineNumber) - \(.problem)"' 2>/dev/null || echo "")
            
            if [ -z "$ERROR_MESSAGES" ]; then
              # Se n√£o h√° erros espec√≠ficos, pegar mensagem geral
              ERROR_MESSAGES=$(echo "$JSON_OUTPUT" | jq -r '.message // .result.message // "Erro desconhecido na valida√ß√£o"' 2>/dev/null || echo "Erro desconhecido na valida√ß√£o")
            fi
            
            echo "validation_errors<<EOF" >> $GITHUB_OUTPUT
            echo "$ERROR_MESSAGES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          
          # Salvar output completo para coment√°rio
          echo "validation_output<<EOF" >> $GITHUB_OUTPUT
          echo "$JSON_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comentar resultado no PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = context.issue.number;
            
            let comment = '## üîç Resultado da Valida√ß√£o no Salesforce (Homolog)\n\n';
            
            if ('${{ steps.validate.outputs.validation_success }}' === 'true') {
              comment += '‚úÖ **Valida√ß√£o conclu√≠da com sucesso!**\n\n';
              comment += 'O PR est√° pronto para merge. O bot√£o de merge foi habilitado.\n';
            } else {
              comment += '‚ùå **Valida√ß√£o falhou!**\n\n';
              comment += '### Erros encontrados:\n\n';
              comment += '```\n';
              
              const errors = `${{ steps.validate.outputs.validation_errors }}`;
              if (errors && errors.trim()) {
                comment += errors;
              } else {
                comment += 'Erro na valida√ß√£o. Verifique os logs do workflow para mais detalhes.';
              }
              
              comment += '\n```\n\n';
              comment += '‚ö†Ô∏è **Aprova√ß√£o anterior foi revogada.** Por favor, corrija os erros e solicite nova valida√ß√£o.\n';
            }
            
            // Adicionar link para o workflow run
            comment += `\n[Ver detalhes do workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
            
            // Comentar no PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

      - name: Revogar aprova√ß√µes se valida√ß√£o falhou
        if: steps.validate.outputs.validation_success != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            
            // Obter reviews do PR
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Revogar aprova√ß√µes (dismiss reviews)
            for (const review of reviews) {
              if (review.state === 'APPROVED') {
                await github.rest.pulls.dismissReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  review_id: review.id,
                  message: 'Aprova√ß√£o revogada devido a falha na valida√ß√£o do Salesforce'
                });
                console.log(`Aprova√ß√£o de ${review.user.login} foi revogada`);
              }
            }

      - name: Habilitar merge se valida√ß√£o passou
        if: steps.validate.outputs.validation_success == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            
            // Verificar se o PR tem aprova√ß√µes
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const approvedReviews = reviews.filter(r => r.state === 'APPROVED');
            
            if (approvedReviews.length > 0) {
              console.log(`PR tem ${approvedReviews.length} aprova√ß√£o(√µes). Merge pode ser realizado.`);
              
              // Adicionar label indicando que est√° pronto para merge
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: ['validated', 'ready-to-merge']
                });
              } catch (error) {
                console.log('Labels podem n√£o existir, continuando...');
              }
            } else {
              console.log('PR ainda precisa de aprova√ß√£o antes do merge');
            }
