<apex:page standardController="Fornecedor__c" extensions="AssistenteRecebimentoProduto" showHeader="false" showChat="false" standardStylesheets="false" docType="html-5.0">
    <html>
        <head>
            <title>Recebimento de itens</title>
            <meta   charset="utf-8" />
            <meta   name="viewport" content="width=device-width, initial-scale=1" />
            <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
            <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
            <link   href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css" rel="stylesheet"/>
            <link   href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.min.css" rel="stylesheet"/>
            <script src="{!URLFOR($Resource.bootstrap3iso, 'js/bootstrap.min.js')}"></script>
            <link   href="{!URLFOR($Resource.bootstrap3iso, 'css/bootstrap.min.css')}" rel="stylesheet"/>
            <link   rel="stylesheet" href="{!$Resource.breadcrumb}" />

            <style>
                .cabecalho-principal{
                    background-color: #f2f7ff!important;
                    padding:4px!important;
                    text-align:center!important;
                    font-size:22px!important;
                    font-weight:bold!important;
                }
                .cabecalho-secundario-a{
                    background-color: #fdfdfd!important;
                    text-align:center!important;
                    padding:5px!important;
                    border-bottom: 1px solid #ddd!important;
                }
                .cabecalho-secundario-b{
                    padding:7px!important;
                    font-size:18px!important;
                }
                .barra-navegacao{
                    padding:8px!important;
                }

                
                .tabela-cabecalho{
                    border-top: 2px solid #ddd!important;
                }
                
                .item-cabecalho{
                    font-weight:bold!important;
                    font-size:12px!important;
                }
                
                .item-descricao{
                    font-size:11.5px!important;
                    border-top-width:1px!important;
                }
                .item-descricao:hover{
                    background-color:#f5f5f5;
                }
                
                .item-rodape{
                    font-size:11.5px!important;
                    border-top-width:1px!important;
                }
                .item-rodape tr:hover{
                    background-color:#f5f5f5;
                }
                .item-rodape-destaque{
                    //text-transform: uppercase!important;
                    font-weight:bold!important;
                    font-size:12px!important;
                }
                .item-pai{
                    background-color:#f9f9f9;
                }
                .maiusculo{
                    text-transform: uppercase!important;
                }
                .datepicker{ 
                    z-index:9999!important;
                    position:relative;
                }
                .alert{
                    font-weight:bold!important;
                    padding-top:10px!important;
                    padding-bottom:10px!important;
                }
            </style>
            <script>
                $(document).ready(function(){
                    
                    // desabilita itens anteriores
                    $("option[value=''], option[value='Novo'], option[value='Aberto'], option[value='Aguardando Compra Fornecedor'], option[value='Aguardando Entrega Fornecedor'], option[value='Cancelado']").each(function(){
                        $(this).prop("disabled", true);
                        $(this).addClass("bg-danger");
                    });
                    
                    // seleciona padrão "Reservado"
                    $("[data-tipo='item-status'] option[value='Reservado']").each(function(){
                        $(this).prop('selected', true);
                    });
                
                    // automatiza ocultamento de cmapos
                    $("[data-tipo='qtd-receber']").on('keyup',function(){
                        if($(this).val()!=null && $(this).val()!='' && parseFloat($(this).val()) > 0){
                            $("[data-tipo='data-receber'][data-id='"+$(this).attr('data-id')+"']").first().show();
                            $("[data-tipo='item-status'][data-id='"+$(this).attr('data-id')+"']").first().show();
                        }
                        else{
                            $("[data-tipo='data-receber'][data-id='"+$(this).attr('data-id')+"']").first().hide();
                            $("[data-tipo='item-status'][data-id='"+$(this).attr('data-id')+"']").first().hide();
                        }
                    });
                    
                });
            </script>
        </head>

        <body style="margin-top:7px;">
            <div class="bootstrap-iso">
                <div class="container-fluid">
                    <apex:form >

                        <!-- painel -->
                        <div class="panel panel-default">

                            <!-- painel: cabeçalho -->
                            <div class="panel-heading cabecalho-principal">
                                Recebimento de itens
                            </div>
                            <div class="panel-body cabecalho-secundario-a">
                                <div class="cabecalho-secundario-b">{!etapa[1]}</div>
                            </div>

                            <!-- painel: corpo -->
                            <div class="panel-body">

                                <!-- erros -->
                                <apex:outputText rendered="{!IF(tem_erros == true, true, false)}" >
                                    <apex:variable var="cont_msg" value="{!0}"/>
                                    <div class="row">
                                        <div class="col-xs-12">
                                            <div class="alert alert-danger alert-dismissible">
                                                <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                                                <apex:repeat value="{!erros}" var="erro">
                                                    <apex:variable var="cont_msg" value="{!cont_msg+1}"/>
                                                    <apex:outputText rendered="{!IF(cont_msg > 1, true, false)}" >
                                                        <br/>
                                                    </apex:outputText>
                                                    {!erro}
                                                </apex:repeat>
                                            </div>                      
                                        </div>
                                    </div>
                                    <br/>
                                </apex:outputText>
                            
                                <!-- corpo: pedido -->
                                <apex:outputText rendered="{!IF(etapa[0] == 'receber', true, false)}" >

                                    <!-- pedido -->
                                    <div class="row">
                                        <div class="col-xs-6">
                                            <label>Cotação {!fornecedor.Pedido_de_compra__r.Name}:  </label>&nbsp;
                                            {!fornecedor.Pedido_de_compra__r.Descricao__c}
                                        </div>
                                        <div class="col-xs-6">
                                            <label>Fornecedor {!fornecedor.Name}:</label>&nbsp;
                                            {!fornecedor.Fornecedor__r.Raz_o_Social__c}
                                        </div>
                                    </div>
                                    <br/>

                                    <!-- filtro  -->
                                    <div class="row">
                                        <div class="col-xs-offset-2 col-xs-8" style="text-align:center;">
                                            <div class="input-group">
                                                <span class="input-group-addon">Filtrar</span>
                                                <input type="text" placeholder="P/N, nome, modelo, etc..." class="form-control input-md" id="caixa-pesquisa" />
                                                <span class="input-group-addon"><i class="glyphicon glyphicon-filter"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                    <br/>
                                    
                                    <!-- itens de fornecedor -->
                                    <div class="row">
                                        <div class="col-xs-12">
                                        
                                            <apex:outputText rendered="{!IF(tem_requisicoes == false, true, false)}" >
                                                <div class="alert alert-info">
                                                    Ainda não há itens com requisições pendentes de recebimentos com este fornecedor.
                                                </div>                      
                                            </apex:outputText>
                                            
                                            <apex:outputText rendered="{!IF(tem_requisicoes == true, true, false)}" >
                                                <table class="table table-condensed" style="width:100%;" id="lista-itens" >

                                                    <!-- cabeçalho -->
                                                    <thead class="tabela-cabecalho">
                                                        <tr>
                                                            <th>&nbsp;</th>
                                                            <th>P/N</th>
                                                            <th>Nome</th>
                                                            <th>Modelo</th>
                                                            <th>Marca</th>
                                                            <th>Qtd Requisitada</th>
                                                            <th colspan="2">Qtd Recebida</th>
                                                            <th>Data Recebimento</th>
                                                            <th>Status Item Venda</th>
                                                        </tr>
                                                    </thead>

                                                    <!-- itens -->
                                                    <apex:repeat value="{!itens}" var="item">
                                                        <tbody class="item-descricao">
                                                            <tr class="item-pai">
                                                                <td>&nbsp;</td>
                                                                <td><apex:outputField value="{!item.item_compra.Codigo_do_produto__c}"/></td>
                                                                <td><apex:outputField value="{!item.item_compra.Nome__c}"/></td>
                                                                <td><apex:outputField value="{!item.item_compra.Modelo__c}"/></td>
                                                                <td><apex:outputField value="{!item.item_compra.Marca__c}"/></td>
                                                                <td><apex:outputText value="{!item.item_compra.Quantidade_requisitada__c}"/></td>
                                                                <td colspan="4"><apex:outputText value="{!item.item_compra.Quantidade_recebida__c}"/></td>
                                                            </tr>
                                                            <apex:repeat value="{!item.reqs_item}" var="req_item">
                                                            <apex:outputText rendered="{!IF(req_item.req_item.RecordTypeId != '0126e000001YbImAAK' || req_item.req_item.Quantidade_direcionada__c != req_item.req_item.Quantidade_requisitada__c, true, false)}">
                                                                <tr>
                                                                    <td>&#8627;</td>
                                                                    <td colspan="5">
                                                                        <!-- "Atender produto de pedido de venda, com produto de pedido de compra." -->
                                                                        <apex:outputText rendered="{!IF(req_item.req_item.RecordType.DeveloperName == 'Atender_venda_com_compra', true, false)}">
                                                                            <b>Pedido Venda: </b><apex:outputField value="{!req_item.req_item.Item_de_pedido_de_venda__r.Order.OrderNumber}"/>
                                                                            | <b>Item Venda: </b><apex:outputField value="{!req_item.req_item.Item_de_pedido_de_venda__r.OrderItemNumber}"/>
                                                                            | <b>Cliente: </b><apex:outputField value="{!req_item.req_item.Item_de_pedido_de_venda__r.Order.Account.Raz_o_Social__c}"/>
                                                                        </apex:outputText>
                                                                        
                                                                        <!-- "Atender produto de estoque, com produto de pedido de compra." -->
                                                                        <apex:outputText rendered="{!IF(req_item.req_item.RecordType.DeveloperName == 'Suprir_estoque_com_compra' || req_item.req_item.RecordType.DeveloperName == 'Compra_Total', true, false)}" >
                                                                            <b>Atender Estoque</b>
                                                                        </apex:outputText>
                                                                    </td>
                                                                    <td><apex:outputText value="{!req_item.req_item.Quantidade_requisitada__c - req_item.req_item.Quantidade_direcionada__c }"/></td>
                                                                    <td><apex:outputText value="{!req_item.req_item.Quantidade_recebida__c}"/> + </td>
                                                                    <td>
                                                                        Quantidade:<apex:inputField value="{!req_item.receb_item.Quantidade_recebida__c}" StyleClass="form-control input-sm" html-data-tipo="qtd-receber" html-data-id="{!req_item.req_item.Id}"/>
                                                                    </td>
                                                                    <td>
                                                                        Data:<apex:inputField value="{!req_item.receb_item.Data_de_recebimento__c}" styleClass="form-control input-sm datepicker" style="display: none;" html-data-tipo="data-receber" html-data-id="{!req_item.req_item.Id}"/>
                                                                    </td>
                                                                    
                                                                    <td>
                                                                        <apex:outputText rendered="{!If(req_item.req_item.RecordType.DeveloperName == 'Atender_venda_com_compra',true,false)}">                                                                             
                                                                            <apex:inputField value="{!req_item.req_item.Item_de_pedido_de_venda__r.Status__c}" styleClass="form-control input-sm" style="display: none;" html-data-tipo="item-status" html-data-id="{!req_item.req_item.Id}"/>
                                                                        </apex:OutputText>
                                                                    </td>
                                                                    
                                                                </tr>
                                                                </apex:outputText>
                                                            </apex:repeat>
                                                        </tbody>
                                                    </apex:repeat>
                                                </table>
                                            </apex:outputText>

                                        </div>
                                    </div>
                                </apex:outputText>

                            </div>

                            <!-- painel: rodapé -->
                            <div class="panel-footer">
                                <div class="row">
                                    <div class="col-xs-offset-4 col-xs-2">
                                        <apex:commandButton styleClass="btn btn-default" style="width:100%;" action="{!RetornarRegistro}" value="Voltar ao Pedido"/>
                                    </div>
                                    <div class="col-xs-2">
                                        <apex:commandButton styleClass="btn btn-default" style="width:100%;" action="{!Efetiva}" value="Salvar Alterações"/>
                                    </div>
                                </div>
                            </div>

                        </div>

                    </apex:form>
                </div>
            </div>
            <script>
                // inicializa campos de filtro
                $("#caixa-pesquisa").val("");
                $("#caixa-pesquisa").on("keyup", function() {
                    var value = $(this).val().toLowerCase();
                    $("#lista-itens tbody").filter(function() {
                        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                    });
                });
                
                $(document).ready(function(){
                    // inicializa calendários em campos data
                    $(".datepicker").datepicker({
                        dateFormat: 'dd/mm/yy'
                    });
                })
            </script>
        </body>
    </html>
</apex:page>