#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Navegar para o diretÃ³rio raiz do projeto
cd "$(git rev-parse --show-toplevel)"

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}ğŸ” Executando validaÃ§Ãµes de pre-commit...${NC}"

# 1. Validar padrÃ£o de nome da branch
echo -e "${YELLOW}ğŸ“‹ Validando padrÃ£o de nome da branch...${NC}"
if ! ./scripts/validate-branch-name.sh; then
    echo -e "${RED}âŒ ValidaÃ§Ã£o do nome da branch falhou${NC}"
    exit 1
fi

# 2. Validar que branch foi criada a partir de stepMaster
echo -e "${YELLOW}ğŸŒ¿ Validando origem da branch (stepMaster)...${NC}"
if ! ./scripts/validate-branch-origin.sh; then
    echo -e "${RED}âŒ ValidaÃ§Ã£o da origem da branch falhou${NC}"
    exit 1
fi

# 3. Executar lint-staged (Prettier + ESLint nos arquivos modificados)
echo -e "${YELLOW}ğŸ’… Executando Prettier e ESLint nos arquivos modificados...${NC}"
if ! npm run precommit; then
    echo -e "${RED}âŒ Lint-staged encontrou problemas${NC}"
    exit 1
fi

# 4. Executar PMD (anÃ¡lise de cÃ³digo Apex) - jÃ¡ roda apenas em arquivos modificados
echo -e "${YELLOW}ğŸ” Executando PMD nos arquivos Apex modificados...${NC}"
if ! ./scripts/run-pmd.sh; then
    echo -e "${RED}âŒ PMD encontrou problemas${NC}"
    exit 1
fi

echo -e "${GREEN}âœ… Todas as validaÃ§Ãµes passaram com sucesso!${NC}"
exit 0