#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Navegar para o diret√≥rio raiz do projeto
cd "$(git rev-parse --show-toplevel)"

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}üîç Executando valida√ß√µes de pre-commit...${NC}"

# 0. Validar se n√£o √© commit direto em branches protegidas
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
CURRENT_USER=$(git config user.name)
PROTECTED_BRANCHES="integration|homolog|stepMaster|main"

if echo "$CURRENT_BRANCH" | grep -qE "^($PROTECTED_BRANCHES)$"; then
    if [ "$CURRENT_USER" != "Weslei Oliveira dos Santos" ]; then
        echo -e "${RED}‚ùå Commits diretos na branch '$CURRENT_BRANCH' n√£o s√£o permitidos!${NC}"
        echo -e "${RED}   Apenas o usu√°rio 'Weslei Oliveira dos Santos' pode fazer commits diretos nesta branch.${NC}"
        echo -e "${YELLOW}   Por favor, crie uma branch de feature/hotfix e fa√ßa um Pull Request.${NC}"
        exit 1
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Usu√°rio autorizado detectado. Commit direto em '$CURRENT_BRANCH' ser√° permitido.${NC}"
    fi
fi

# 1. Validar que branch foi criada a partir de stepMaster
echo -e "${YELLOW}üåø Validando origem da branch (stepMaster)...${NC}"
if ! ./scripts/validate-branch-origin.sh; then
    echo -e "${RED}‚ùå Valida√ß√£o da origem da branch falhou${NC}"
    exit 1
fi

# 2. Executar Prettier e ESLint (apenas em arquivos alterados)
echo -e "${YELLOW}üíÖ Executando Prettier e ESLint...${NC}"
npm run precommit

# 4. Executar PMD (an√°lise de c√≥digo Apex)
echo -e "${YELLOW}üîé Executando PMD...${NC}"
if ! ./scripts/run-pmd.sh; then
    echo -e "${RED}‚ùå PMD encontrou problemas${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Todas as valida√ß√µes passaram com sucesso!${NC}"
exit 0